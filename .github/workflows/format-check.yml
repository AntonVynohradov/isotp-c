name: Code Formatting Check

on:
  pull_request:
    branches:
      - development
      - main
    paths:
      - '**.c'
      - '**.h'
      - '.clang-format'

jobs:
  format-check:
    name: Verify Code Formatting
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Verify clang-format version
        run: clang-format --version

      - name: Check C/H files formatting
        id: format-check
        run: |
          echo "Checking code formatting with clang-format..."
          FILES=$(find . -type f \( -name "*.c" -o -name "*.h" \) 2>/dev/null || true)

          if [ -z "$FILES" ]; then
            echo "No C/H files found"
            exit 0
          fi

          NEEDS_FORMATTING=false

          for file in $FILES; do
            clang-format "$file" > "${file}.formatted"

            if ! diff -q "$file" "${file}.formatted" > /dev/null; then
              NEEDS_FORMATTING=true
              echo "❌ File needs formatting: $file"
            else
              echo "✅ File is properly formatted: $file"
            fi

            rm "${file}.formatted"
          done

          if [ "$NEEDS_FORMATTING" = true ]; then
            echo "formatting_needed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "formatting_needed=false" >> $GITHUB_OUTPUT
            echo "✅ All files are properly formatted!"
          fi

  format-fix:
    name: Auto-fix Formatting (Optional)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Auto-format code
        id: auto-format
        run: |
          FILES=$(find . -type f \( -name "*.c" -o -name "*.h" \) 2>/dev/null || true)

          if [ -z "$FILES" ]; then
            echo "No C/H files found"
            exit 0
          fi

          FORMATTED_COUNT=0

          for file in $FILES; do
            clang-format "$file" > "${file}.formatted"

            if ! diff -q "$file" "${file}.formatted" > /dev/null; then
              mv "${file}.formatted" "$file"
              FORMATTED_COUNT=$((FORMATTED_COUNT + 1))
              echo "Formatted: $file"
            else
              rm "${file}.formatted"
            fi
          done

          echo "formatted_count=$FORMATTED_COUNT" >> $GITHUB_OUTPUT

      - name: Commit formatting changes
        if: steps.auto-format.outputs.formatted_count > 0
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git commit -m "style: apply clang-format"
          git push
