name: Mandatory Code Review & Issue Resolution Check

on:
  pull_request:
    branches:
      - development
      - main
  pull_request_review:
    types:
      - submitted
      - edited
      - dismissed

jobs:
  check-code-review:
    name: Verify Copilot Code Review
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Copilot code review approval
        id: check-review
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          
          # Get all reviews for the PR
          REVIEWS=$(gh api repos/$REPO/pulls/$PR_NUMBER/reviews \
            --jq '.[] | select(.user.login | contains("copilot") or contains("github-actions")) | .state')
          
          # Check if there's an APPROVED review from Copilot/GitHub Actions
          if echo "$REVIEWS" | grep -q "APPROVED"; then
            echo "copilot_review=approved" >> $GITHUB_OUTPUT
            echo "‚úÖ Copilot code review approved"
          else
            echo "copilot_review=pending" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Copilot code review pending"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Fail if Copilot review not approved
        if: steps.check-review.outputs.copilot_review != 'approved'
        run: |
          echo "‚ùå ERROR: Copilot code review is mandatory!"
          echo ""
          echo "Required:"
          echo "1. Copilot must approve the code review"
          echo "2. Follow the guidelines in .copilot-instructions.md"
          echo "3. Address all review comments"
          exit 1

  check-open-issues:
    name: Verify Related Issues Are Closed
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find linked issues in PR
        id: find-issues
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          
          # Extract issue references from PR body
          PR_BODY=${{ github.event.pull_request.body }}
          
          # Pattern to match: fixes #123, closes #456, etc.
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE 'fix[es]*|close[ds]*|resolves?' | \
            grep -oE '#[0-9]+' | sed 's/#//' | tr '\n' ' ')
          
          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "no_linked_issues=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No linked issues found in PR body"
          else
            echo "issue_numbers=$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
            echo "Found linked issues: $ISSUE_NUMBERS"
          fi

      - name: Check if linked issues are closed
        if: steps.find-issues.outputs.no_linked_issues != 'true'
        run: |
          REPO=${{ github.repository }}
          ISSUE_NUMBERS="${{ steps.find-issues.outputs.issue_numbers }}"
          
          OPEN_ISSUES=()
          
          for ISSUE_NUM in $ISSUE_NUMBERS; do
            STATE=$(gh api repos/$REPO/issues/$ISSUE_NUM \
              --jq '.state')
            
            if [ "$STATE" = "open" ]; then
              OPEN_ISSUES+=($ISSUE_NUM)
            fi
          done
          
          if [ ${#OPEN_ISSUES[@]} -gt 0 ]; then
            echo "‚ùå ERROR: The following linked issues are still open:"
            for ISSUE in "${OPEN_ISSUES[@]}"; do
              echo "  - Issue #$ISSUE"
            done
            exit 1
          else
            echo "‚úÖ All linked issues are closed"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  check-code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run static analysis (cppcheck)
        continue-on-error: true
        run: |
          which cppcheck > /dev/null 2>&1 || sudo apt-get install -y cppcheck
          
          echo "Running cppcheck..."
          cppcheck --enable=all --suppress=missingIncludeSystem \
            Src/ Inc/ --error-exitcode=1 || {
            echo "‚ö†Ô∏è cppcheck found issues (non-blocking)"
          }

      - name: Verify compilation without warnings
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make VERBOSE=1 2>&1 | tee build.log
          
          # Check for warnings
          if grep -i "warning:" build.log; then
            echo "‚ö†Ô∏è Compiler warnings detected (review recommended)"
          fi

      - name: Check for code style issues
        continue-on-error: true
        run: |
          # Basic checks for code style
          echo "Checking for common issues..."
          
          # Check for unsafe functions
          if grep -r "strcpy\|strcat\|sprintf\|gets\|scanf" Src/ Inc/ \
            --include="*.c" --include="*.h"; then
            echo "‚ö†Ô∏è Unsafe string functions detected"
          fi
          
          # Check for missing const
          echo "‚úì Code style checks completed"

  summary:
    name: Merge Readiness Summary
    needs: [check-code-review, check-open-issues, check-code-quality]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check merge readiness
        run: |
          echo "üìã Merge Readiness Status:"
          echo ""
          
          if [ "${{ needs.check-code-review.result }}" = "success" ]; then
            echo "‚úÖ Copilot Code Review: PASSED"
          else
            echo "‚ùå Copilot Code Review: FAILED"
          fi
          
          if [ "${{ needs.check-open-issues.result }}" = "success" ]; then
            echo "‚úÖ Issue Resolution: PASSED"
          else
            echo "‚ùå Issue Resolution: FAILED"
          fi
          
          if [ "${{ needs.check-code-quality.result }}" = "success" ]; then
            echo "‚úÖ Code Quality: PASSED"
          else
            echo "‚ö†Ô∏è Code Quality: WARNINGS (non-blocking)"
          fi
          
          echo ""
          
          # Fail if critical checks fail
          if [ "${{ needs.check-code-review.result }}" != "success" ] || \
             [ "${{ needs.check-open-issues.result }}" != "success" ]; then
            echo "‚ùå Cannot merge: Critical checks failed"
            exit 1
          fi
          
          echo "‚úÖ Ready to merge on branch: development"
