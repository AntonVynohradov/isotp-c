name: Check Building Static Library

on:
  push:
    branches:
      - development
  pull_request:
    branches:
      - development
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure (Debug preset)
        run: cmake --preset "ISO-TP[Debug]" -B "build/ISO-TP[Debug]"

      - name: Build
        run: cmake --build "build/ISO-TP[Debug]"

      - name: Configure (Release preset)
        run: cmake --preset "ISO-TP[Release]" -B "build/ISO-TP[Release]"

      - name: Build
        run: cmake --build "build/ISO-TP[Release]"

  cppcheck:
    name: Cppcheck Analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run Cppcheck
        run: |
          mkdir -p cppcheck-report
          cppcheck --enable=all --inconclusive --std=c17 --force \
            --exclude-list=cppcheck-excludes.txt \
            --xml --xml-version=2 . 2> cppcheck-report/cppcheck.xml
          cppcheck-htmlreport --file=cppcheck-report/cppcheck.xml \
            --report-dir=cppcheck-report/html --source-dir=.

      - name: Upload Cppcheck report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-html
          path: cppcheck-report/html

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: c

      - name: Perform CodeQL Database Build
        uses: github/codeql-action/autobuild@v3

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: codeql-report

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install SARIF Multitool locally
        run: |
          mkdir -p .sarif-tools
          dotnet tool install Sarif.Multitool \
            --tool-path .sarif-tools

      - name: Convert SARIF to HTML
        run: |
          mkdir -p codeql-report/html
          for sarif in codeql-report/*.sarif; do
            name=$(basename "$sarif" .sarif)
            .sarif-tools/sarif export \
              --sarif-file "$sarif" \
              --format Html \
              --output "codeql-report/html/${name}.html"
          done

      - name: Upload CodeQL report
        uses: actions/upload-artifact@v4
        with:
          name: codeql-report
          path: codeql-report
